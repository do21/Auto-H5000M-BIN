# æ„å»º ImmortalWrt H5000M å›ºä»¶çš„ GitHub Actions å·¥ä½œæµ
name: Build ImmortalWrt H5000M

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

# æƒé™ï¼šå…è®¸å†™å…¥å†…å®¹ï¼ˆç”¨äºåˆ›å»º releaseï¼‰
permissions:
  contents: write

# ç¯å¢ƒå˜é‡
env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10  # ImmortalWrt æºç ä»“åº“ URL
  REPO_BRANCH: mt798x-mt799x-6.6-mtwifi  # æºç åˆ†æ”¯
  CONFIG_FILE: mt7987_mt7992.config  # é»˜è®¤é…ç½®æ–‡ä»¶
  TZ: Asia/Shanghai  # æ—¶åŒº
  SOURCE_DIR: immortalwrt  # æºç ç›®å½•

# ä½œä¸šå®šä¹‰
jobs:
  build:  # æ„å»ºä½œä¸š
    runs-on: ubuntu-22.04  # è¿è¡Œç¯å¢ƒ
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: ç¼“å­˜ç¼–è¯‘å™¨ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
          key: ${{ runner.os }}-ccache-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ env.CONFIG_FILE }}-
      - name: æ¢å¤æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-
      - name: å…‹éš†æºç å¹¶è®¾ç½® feeds
        run: |
          if [ -d "$SOURCE_DIR/.git" ]; then
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          else
            rm -rf $SOURCE_DIR
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            cd $SOURCE_DIR
          fi

          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
            echo "ä½¿ç”¨è‡ªå®šä¹‰ feeds.conf.default"
          else
            echo "ä½¿ç”¨é»˜è®¤ feeds.conf.default"
          fi

          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

          [ ! -d "package/luci-app-adguardhome" ] && \
            git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome || true

          AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
          if [ -f "$AGH_LUCI_SCRIPT" ]; then
            sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
          fi

          rm -rf package/feeds/packages/exim package/feeds/packages/onionshare-cli package/feeds/packages/python-zope-event package/feeds/packages/python-zope-interface 2>/dev/null || true
      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          cp -f defconfig/$CONFIG_FILE .config

          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
            echo "è¿½åŠ äº†æ¥è‡ª h5000m.extra.config çš„é¢å¤–é…ç½®"
          else
            echo "æœªæ‰¾åˆ°é¢å¤–é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤ .config"
          fi

          make defconfig || true
      - name: éªŒè¯æ„å»ºé…ç½®
        run: |
          cd $SOURCE_DIR
          echo "ğŸ“¦ å…³é”®åŒ…é…ç½®çŠ¶æ€:"
          grep -E "CONFIG_PACKAGE_(qmodem|luci-app-qmodem|adguardhome|mihomo)=" .config || echo "æŸäº›åŒ…åœ¨é…ç½®ä¸­æœªæ‰¾åˆ°"
      - name: ä¸‹è½½å¹¶ç¼–è¯‘
        run: |
          cd $SOURCE_DIR
          THREADS=$(($(nproc) + 1))
          export PATH="/usr/lib/ccache:$PATH"
          for i in 1 2 3; do make download -j16 && break; find dl -size -1024c -delete 2>/dev/null; sleep 3; done
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ (${THREADS} çº¿ç¨‹)..."
          make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || make -j1 V=s || true
      - name: å‡†å¤‡å¹¶ä¸Šä¼ äº§ç‰©
        run: |
          mkdir -p artifacts
          find $SOURCE_DIR/bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} artifacts/ \; || true
          if [ "$(ls -A artifacts/ 2>/dev/null)" ]; then
            ls -lh artifacts/
          else
            echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ï¼Œè·³è¿‡ä¸Šä¼ "
            exit 1
          fi
      - name: ä¸Šä¼ åˆ° Actions
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImmortalWrt-MT7987-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
      - name: åˆ›å»ºé¢„å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        if: success() && hashFiles('artifacts/*') != ''
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt MT7987/MT7992 #${{ github.run_number }}
          body: |
            ğŸ”§ è‡ªåŠ¨æ„å»º ImmortalWrt MT7987/MT7992 å›ºä»¶
            ğŸ“… æ—¶é—´: ${{ github.event.repository.updated_at }}
            ğŸŒ¿ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          prerelease: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ä¿å­˜æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        if: always()
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/staging_dir/target-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ hashFiles('**/feeds.conf.default') }}-${{ github.run_id }}
